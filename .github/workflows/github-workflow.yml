# ============================================
# FRAPPE APP AUTO-DEPLOYMENT WORKFLOW
# ============================================
# Bu fayl TEMPLATE - har bir projectga nusxa ko'chiring!
#
# USAGE:
# 1. Bu faylni nusxa ko'chiring: akfa_accounting/.github/workflows/deploy.yml
# 2. GitHub Settings â†’ Secrets â†’ Actions da quyidagilarni qo'shing:
#    - SERVER_IP
#    - SSH_PRIVATE_KEY
#    - SITE_NAME
#    - DB_PASSWORD
#    - ADMIN_PASSWORD
#    - APPS_TO_INSTALL (ixtiyoriy)
# 3. main branch ga push qiling - avtomatik deploy bo'ladi!
#
# ============================================

name: Deploy to Production

# Qachon ishga tushadi
on:
  push:
    branches:
      - main              # main branch ga push bo'lganda
  workflow_dispatch:      # Manual trigger ham mumkin

# Environment variables (GitHub Secrets dan olinadi)
env:
  FRAPPE_VERSION: "version-15"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  BENCH_PATH: "/home/frappe/frappe-bench"

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # 1. CODE CHECKOUT
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history (for versioning)

      # ============================================
      # 2. SETUP SSH
      # ============================================
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # ============================================
      # 3. VALIDATE SECRETS
      # ============================================
      - name: Validate Configuration
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "âŒ ERROR: SERVER_IP secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SITE_NAME }}" ]; then
            echo "âŒ ERROR: SITE_NAME secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret not set!"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      # ============================================
      # 4. CREATE .env FILE FROM SECRETS
      # ============================================
      - name: Generate .env from Secrets
        run: |
          cat > .env << EOF
          # ============================================
          # AUTO-GENERATED FROM GITHUB SECRETS
          # Generated: $(date)
          # ============================================
          
          # SERVER CONFIGURATION
          SERVER_IP="${{ secrets.SERVER_IP }}"
          SERVER_USER="root"
          
          # FRAPPE CONFIGURATION
          FRAPPE_USER="frappe"
          SITE_NAME="${{ secrets.SITE_NAME }}"
          FRAPPE_VERSION="${{ env.FRAPPE_VERSION }}"
          
          # DATABASE CONFIGURATION
          MARIADB_ROOT_PASSWORD="${{ secrets.DB_PASSWORD }}"
          ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          
          # APPS CONFIGURATION
          # Auto-detect from repository
          APPS_TO_INSTALL="${{ secrets.APPS_TO_INSTALL || 'frappe,erpnext' }}"
          CUSTOM_APP_REPO="${{ github.server_url }}/${{ github.repository }}.git"
          CUSTOM_APP_BRANCH="${{ github.ref_name }}"
          
          # BACKUP CONFIGURATION
          RESTORE_BACKUP="false"
          
          # PRODUCTION SETTINGS
          DEVELOPER_MODE="false"
          ENABLE_SCHEDULER="true"
          SETUP_SSL="${{ secrets.SETUP_SSL || 'false' }}"
          SSL_DOMAIN="${{ secrets.SSL_DOMAIN || '' }}"
          SSL_EMAIL="${{ secrets.SSL_EMAIL || '' }}"
          
          # ADVANCED SETTINGS
          BENCH_PATH="${{ env.BENCH_PATH }}"
          PYTHON_VERSION="${{ env.PYTHON_VERSION }}"
          NODE_VERSION="${{ env.NODE_VERSION }}"
          EOF
          
          echo "âœ… .env file generated successfully"

      # ============================================
      # 5. CHECK IF DEPLOYMENT EXISTS
      # ============================================
      - name: Check Deployment Status
        id: check_deploy
        run: |
          # Serverda frappe-bench bormi tekshirish
          if ssh root@${{ secrets.SERVER_IP }} "[ -d ${{ env.BENCH_PATH }} ]"; then
            echo "deployment_exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Existing deployment found - will update"
          else
            echo "deployment_exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• No deployment found - will do fresh install"
          fi

      # ============================================
      # 6A. FRESH DEPLOYMENT (First time)
      # ============================================
      - name: Fresh Deployment
        if: steps.check_deploy.outputs.deployment_exists == 'false'
        run: |
          echo "ðŸš€ Starting fresh deployment..."
          
          # Upload deployment scripts to server
          scp -r deploy/ backups/ .env root@${{ secrets.SERVER_IP }}:/root/frappe_deployment/
          
          # Run deployment script
          ssh root@${{ secrets.SERVER_IP }} << 'ENDSSH'
            cd /root/frappe_deployment
            chmod +x deploy/deploy.sh
            ./deploy/deploy.sh
          ENDSSH
          
          echo "âœ… Fresh deployment completed!"

      # ============================================
      # 6B. UPDATE EXISTING DEPLOYMENT
      # ============================================
      - name: Update Existing Deployment
        if: steps.check_deploy.outputs.deployment_exists == 'true'
        run: |
          echo "ðŸ”„ Updating existing deployment..."
          
          # Extract app name from repository
          APP_NAME=$(basename ${{ github.repository }})
          echo "ðŸ“¦ App name: ${APP_NAME}"
          
          ssh root@${{ secrets.SERVER_IP }} << ENDSSH
            # Switch to frappe user for bench operations
            su - frappe << 'FRAPPE_EOF'
          set -e
          cd ${{ env.BENCH_PATH }}
          
          # Enable maintenance mode
          echo "ðŸ”§ Enabling maintenance mode..."
          bench --site ${{ secrets.SITE_NAME }} set-maintenance-mode on || true
          
          # Pull latest code - Auto-detect remote name
          echo "ðŸ“¥ Pulling latest code for ${APP_NAME}..."
          cd apps/${APP_NAME}
          
          # Detect remote name (origin or upstream)
          REMOTE_NAME=\$(git remote | head -1)
          echo "ðŸ”— Using remote: \${REMOTE_NAME}"
          
          # Pull latest changes
          git fetch \${REMOTE_NAME}
          git reset --hard \${REMOTE_NAME}/${{ github.ref_name }}
          
          echo "âœ… Code updated to latest commit:"
          git log -1 --oneline
          
          cd ${{ env.BENCH_PATH }}
          
          # Install dependencies
          echo "ðŸ“¦ Installing Python dependencies..."
          bench setup requirements || true
          
          # Run migrations
          echo "ðŸ—„ï¸  Running database migrations..."
          bench --site ${{ secrets.SITE_NAME }} migrate
          
          # Build assets
          echo "ðŸŽ¨ Building frontend assets..."
          bench build --app ${APP_NAME}
          
          # Clear cache
          echo "ðŸ§¹ Clearing cache..."
          bench --site ${{ secrets.SITE_NAME }} clear-cache
          bench --site ${{ secrets.SITE_NAME }} clear-website-cache
          
          # Disable maintenance mode
          echo "âœ… Disabling maintenance mode..."
          bench --site ${{ secrets.SITE_NAME }} set-maintenance-mode off
          
          echo "âœ… Frappe user tasks completed!"
          FRAPPE_EOF
          
          # Restart services (as root)
          echo "ðŸ”„ Restarting services..."
          supervisorctl restart all
          systemctl reload nginx || true
          
          echo "âœ… Deployment updated successfully!"
          ENDSSH

      # ============================================
      # 7. HEALTH CHECK
      # ============================================
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health check..."
          
          # Wait for services to start
          sleep 10
          
          # Check if site is accessible
          SITE_URL="http://${{ secrets.SERVER_IP }}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $SITE_URL || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Site is accessible! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Warning: Site returned HTTP $HTTP_CODE"
            echo "This might be normal if SSL redirect is configured"
          fi
          
          # Check via SSH
          ssh root@${{ secrets.SERVER_IP }} << 'ENDSSH'
            echo "ðŸ“Š Service Status:"
            supervisorctl status | head -5
            
            echo ""
            echo "ðŸ’¾ Disk Usage:"
            df -h / | tail -1
            
            echo ""
            echo "ðŸ§  Memory Usage:"
            free -h | grep Mem
          ENDSSH

      # ============================================
      # 8. SEND NOTIFICATION (Optional)
      # ============================================
      - name: Send Success Notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo ""
          echo "ðŸŒ Site: http://${{ secrets.SERVER_IP }}"
          echo "ðŸ“¦ App: ${{ github.repository }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          
          # Agar webhook URL bo'lsa, notification yuborish
          # curl -X POST ${{ secrets.WEBHOOK_URL }} -d "Deployment successful!"

      - name: Send Failure Notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs above for details"
          
          # Agar webhook URL bo'lsa, error yuborish
          # curl -X POST ${{ secrets.WEBHOOK_URL }} -d "Deployment failed!"

# ============================================
# SECURITY NOTES
# ============================================
# 1. HECH QACHON parollarni code da yozmang!
# 2. Barcha sensitive data GitHub Secrets da
# 3. SSH key ni hech qachon commit qilmang!
# 4. .env faylni .gitignore ga qo'shing
# ============================================