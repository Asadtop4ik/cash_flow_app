{% set total_with_interest = doc.get("custom_grand_total_with_interest") or doc.grand_total %}
{% set downpayment = doc.get("custom_downpayment_amount") or 0 %}
{% set finance_amount = total_with_interest - downpayment %}

<div class="shartnoma-print" style="font-family: Arial, sans-serif; padding: 20px;">
	
	<!-- Header with Letter Head -->
	{% if letter_head %}
		{{ letter_head }}
	{% endif %}
	
	<!-- Title -->
	<div style="text-align: center; margin: 30px 0 40px 0;">
		<h2 style="margin: 0; font-size: 24px; font-weight: bold; text-transform: uppercase;">
			MUDDATLI TO'LOV SHARTNOMASI
		</h2>
		<p style="margin: 10px 0 0 0; font-size: 14px;">
			№ {{ doc.name }} / {{ frappe.utils.formatdate(doc.transaction_date, 'dd.MM.yyyy') }}
		</p>
	</div>
	
	<!-- Contract Info -->
	<div style="margin-bottom: 30px;">
		<table style="width: 100%; border-collapse: collapse;">
			<tr>
				<td style="width: 30%; padding: 8px 0; font-weight: bold;">Shartnoma sanasi:</td>
				<td style="padding: 8px 0;">{{ frappe.utils.formatdate(doc.transaction_date, 'dd.MM.yyyy') }}</td>
			</tr>
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Mijoz:</td>
				<td style="padding: 8px 0;">{{ doc.customer_name or doc.customer }}</td>
			</tr>
			{% if doc.contact_display %}
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Telefon:</td>
				<td style="padding: 8px 0;">{{ doc.contact_display }}</td>
			</tr>
			{% endif %}
			{% if doc.cost_center %}
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Filial:</td>
				<td style="padding: 8px 0;">{{ doc.cost_center }}</td>
			</tr>
			{% endif %}
		</table>
	</div>
	
	<!-- Items Table -->
	<div style="margin-bottom: 30px;">
		<h3 style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">MAHSULOTLAR RO'YXATI</h3>
		<table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
			<thead>
				<tr style="background-color: #f5f5f5;">
					<th style="border: 1px solid #ddd; padding: 10px; text-align: left;">#</th>
					<th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Mahsulot</th>
					<th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Miqdor</th>
				</tr>
			</thead>
			<tbody>
				{% for item in doc.items %}
				<tr>
					<td style="border: 1px solid #ddd; padding: 10px;">{{ loop.index }}</td>
					<td style="border: 1px solid #ddd; padding: 10px;">
						{{ item.item_name or item.item_code }}
						{% if item.get("custom_imei") %}
						<br><small style="color: #666;">IMEI: {{ item.custom_imei }}</small>
						{% endif %}
					</td>
					<td style="border: 1px solid #ddd; padding: 10px; text-align: center;">{{ item.qty }}</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	
	<!-- Payment Schedule -->
	{% if doc.payment_schedule %}
	<div style="margin-bottom: 30px;">
		<h3 style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">TO'LOV JADVALI</h3>
		<table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
			<thead>
				<tr style="background-color: #f5f5f5;">
					<th style="border: 1px solid #ddd; padding: 10px; text-align: left;">#</th>
					<th style="border: 1px solid #ddd; padding: 10px; text-align: left;">To'lov sanasi</th>
					<th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Summa (USD)</th>
					<th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Holat</th>
				</tr>
			</thead>
			<tbody>
				{% for schedule in doc.payment_schedule %}
				<tr>
					<td style="border: 1px solid #ddd; padding: 10px;">{{ loop.index }}</td>
					<td style="border: 1px solid #ddd; padding: 10px;">{{ frappe.utils.formatdate(schedule.due_date, 'dd.MM.yyyy') }}</td>
					<td style="border: 1px solid #ddd; padding: 10px; text-align: right;">{{ "{:,.2f}".format(schedule.payment_amount) }} USD</td>
					<td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
						{% if schedule.paid_amount >= schedule.payment_amount %}
							<span style="color: green;">✓ To'langan</span>
						{% else %}
							<span style="color: orange;">Kutilmoqda</span>
						{% endif %}
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% endif %}
	
	<!-- Payment Summary -->
	<div style="margin-bottom: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 5px;">
		<h3 style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">TO'LOV SHARTLARI</h3>
		<table style="width: 100%; border-collapse: collapse;">
			<tr>
				<td style="padding: 8px 0; width: 50%; font-weight: bold;">Mahsulot qiymati:</td>
				<td style="padding: 8px 0; text-align: right; font-size: 16px;">{{ "{:,.2f}".format(doc.grand_total) }} USD</td>
			</tr>
			{% if downpayment > 0 %}
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Boshlang'ich to'lov:</td>
				<td style="padding: 8px 0; text-align: right; font-size: 16px;">{{ "{:,.2f}".format(downpayment) }} USD</td>
			</tr>
			{% endif %}
			{# 
			INTERNAL USE ONLY - DO NOT SHOW TO CLIENT
			Foyda summasi va foiz mijozga ko'rsatilmaydi 
			#}
			<tr style="border-top: 2px solid #ddd;">
				<td style="padding: 12px 0; font-weight: bold; font-size: 18px;">JAMI TO'LOV:</td>
				<td style="padding: 12px 0; text-align: right; font-size: 18px; font-weight: bold; color: #0275d8;">{{ "{:,.2f}".format(total_with_interest) }} USD</td>
			</tr>
			{% if doc.get("custom_installment_months") %}
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Muddat:</td>
				<td style="padding: 8px 0; text-align: right; font-size: 16px;">{{ doc.custom_installment_months }} oy</td>
			</tr>
			<tr>
				<td style="padding: 8px 0; font-weight: bold;">Oylik to'lov:</td>
				<td style="padding: 8px 0; text-align: right; font-size: 16px; font-weight: bold; color: #5cb85c;">{{ "{:,.2f}".format(doc.get("custom_monthly_payment") or 0) }} USD</td>
			</tr>
			{% endif %}
		</table>
	</div>
	
	<!-- Terms and Conditions -->
	<div style="margin-bottom: 30px;">
		<h3 style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">SHARTNOMA SHARTLARI</h3>
		<ol style="line-height: 1.8; font-size: 14px;">
			<li>Mijoz mahsulotni ko'rsatilgan sanada va narxda sotib olishga rozilik bildiradi.</li>
			<li>To'lov jadvali bo'yicha har oylik to'lov belgilangan sanada amalga oshirilishi kerak.</li>
			<li>To'lovni kechiktirish uchun qo'shimcha jarima solinishi mumkin.</li>
			<li>Mahsulot to'liq to'lanmaguncha kompaniya mulki hisoblanadi.</li>
			<li>Shartnoma ikki tomon o'rtasida kelishilgan holda tuzilgan va imzolangan.</li>
		</ol>
	</div>
	
	<!-- Signatures -->
	<div style="margin-top: 60px;">
		<table style="width: 100%;">
			<tr>
				<td style="width: 45%; vertical-align: bottom;">
					<div style="border-top: 1px solid #333; padding-top: 5px; margin-top: 50px;">
						<strong>Sotuvchi:</strong><br>
						<small>F.I.O / Imzo</small>
					</div>
				</td>
				<td style="width: 10%;"></td>
				<td style="width: 45%; vertical-align: bottom;">
					<div style="border-top: 1px solid #333; padding-top: 5px; margin-top: 50px;">
						<strong>Xaridor (Mijoz):</strong><br>
						<small>{{ doc.customer_name or doc.customer }} / Imzo</small>
					</div>
				</td>
			</tr>
		</table>
	</div>
	
	<!-- Footer -->
	<div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
		<p>Shartnoma elektron tizimda yaratilgan. Tizim raqami: {{ doc.name }}</p>
		<p>Chop etilgan sana: {{ frappe.utils.now_datetime().strftime('%d.%m.%Y %H:%M') }}</p>
	</div>
	
</div>

<style>
@media print {
	.shartnoma-print {
		padding: 0;
	}
	@page {
		size: A4;
		margin: 15mm;
	}
}
</style>
